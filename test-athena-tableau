CREATE TABLE ctas_interim_call_legs_v1
WITH (
      format = 'Parquet',
      write_compression = 'SNAPPY')
AS
SELECT
    "ref.phone.service",
    "ref.queue.service",
    SUBSTR(initiationtimestamp,1, 10) as when_date,
    SUBSTR(initiationtimestamp, 12, 5) as when_time,
    SUBSTR(initiationtimestamp, 12, 2) as when_hour,
    date_format(CAST(SUBSTR(initiationtimestamp,1, 10) AS DATE), '%W') as when_day,
    date_format(CAST(SUBSTR(initiationtimestamp,1, 10) AS DATE), '%Y-%v') as when_week,
    CASE "initiationmethod" WHEN 'INBOUND' THEN 1 ELSE 0 END AS flag_inbound,
    CASE "initiationmethod" WHEN 'OUTBOUND' THEN 1 ELSE 0 END AS flag_outbound,
    CASE WHEN "initiationmethod" IN ('INBOUND','OUTBOUND') THEN 0 ELSE 1 END AS flag_other,
    "initiationtimestamp","initiationmethod","initialcontactid","systemendpoint.address","systemendpoint.type","agent.username","disconnectreason","contactid",
    "agent.routingprofile.name","queue.name","customerendpoint.address","queue.duration","attributes.timeinqueue","agent.agentinteractionduration",
    "agent.aftercontactworkduration","agent.customerholdduration","agent.longestholdduration","agent.numberofholds","agentconnectionattempts",
    "transferredtoendpoint.address","transferredtoendpoint.type","agent.hierarchygroups.level1.groupname","agent.hierarchygroups.level2.groupname",
    "agent.hierarchygroups.level3.groupname","agent.hierarchygroups.level4.groupname","agent.hierarchygroups.level5.groupname","attributes.numberofquestion",
    "attributes.question1","attributes.question1response","attributes.question2","attributes.question2response","attributes.question3",
    "attributes.question3response","attributes.question4","attributes.question4response","attributes.question5","attributes.question5response","queue.enqueuetimestamp",
    "queue.dequeuetimestamp","connectedtosystemtimestamp","agent.connectedtoagenttimestamp","disconnecttimestamp","lastupdatetimestamp","transfercompletedtimestamp",
    "agent.aftercontactworkstarttimestamp","agent.aftercontactworkendtimestamp","previouscontactid","nextcontactid","attributes.ooh_calls",
    "attributes.vmcalledservice","attributes.vmreceiveremail","attributes.vmsenderemail","attributes.finalservice","attributes.flowselection",
    "attributes.keypress","attributes.servicename","attributes.outcome","attributes.connectcontactid","attributes.endfragmentnum","attributes.startfragmentnum",
    "attributes.appname","attributes.language_check","attributes.transfername","attributes.istransfer","attributes.formember","attributes.memberid",
    "attributes.region","attributes.pensionwise","attributes.holidayname","attributes.publicholiday","attributes.ca_holiday","attributes.voicemailstatus",
    "attributes.country","references","channel","customerendpoint.type",
    CASE WHEN "ref.phone.service" = 'Adviceline' OR "ref.queue.service" = 'Adviceline' THEN 1 ELSE 0 END AS dataset_advice_line,
    CASE WHEN "ref.phone.service" = 'Advicelink' OR "ref.queue.service" = 'Advicelink' THEN 1 ELSE 0 END AS dataset_advice_link,
    CASE WHEN "ref.phone.service" = 'Birmingham Debt' OR "ref.queue.service" = 'Birmingham Debt' THEN 1 ELSE 0 END AS dataset_brum_det,
    CASE WHEN "ref.phone.service" = 'Birmingham Macmillan' OR "ref.queue.service" = 'Birmingham Macmillan' THEN 1 ELSE 0 END AS dataset_brum_mac,
    CASE WHEN "ref.phone.service" = 'Client Services' OR "ref.queue.service" = 'Client Services' THEN 1 ELSE 0 END AS dataset_client,
    CASE WHEN "ref.phone.service" = 'Consumer Operations' OR "ref.queue.service" = 'Consumer Operations' THEN 1 ELSE 0 END AS dataset_consumer_ops,
    CASE WHEN "ref.phone.service" = 'Consumer Service' OR "ref.queue.service" = 'Consumer Service' THEN 1 ELSE 0 END AS dataset_consumer_srv,
    CASE WHEN "ref.phone.service" = 'Dudley Empowerment' OR "ref.queue.service" = 'Dudley Empowerment' THEN 1 ELSE 0 END AS dataset_dudley,
    CASE WHEN "ref.phone.service" = 'EDF' OR "ref.queue.service" = 'EDF' THEN 1 ELSE 0 END AS dataset_edf,
    CASE WHEN "ref.phone.service" = 'EU Citizens Rights' OR "ref.queue.service" = 'EU Citizens Rights' THEN 1 ELSE 0 END AS dataset_eu,
    CASE WHEN "ref.phone.service" = 'Healthwatch Isle of Wight' OR "ref.queue.service" = 'Healthwatch Isle of Wight' THEN 1 ELSE 0 END AS dataset_iow,
    CASE WHEN "ref.phone.service" = 'Help Through Hardship' OR "ref.queue.service" = 'Help Through Hardship' THEN 1 ELSE 0 END AS dataset_hth, 
    CASE WHEN "ref.phone.service" = 'Help To Claim' OR "ref.queue.service" = 'Help To Claim' THEN 1 ELSE 0 END AS dataset_htc,
    CASE WHEN "ref.phone.service" = 'Advisory Immigration' OR "ref.queue.service" = 'Advisory Immigration' THEN 1 ELSE 0 END AS dataset_imm,
    CASE WHEN "ref.phone.service" = 'IT Service Desk' OR "ref.queue.service" = 'IT Service Desk' THEN 1 ELSE 0 END AS dataset_it,
    CASE WHEN "ref.phone.service" = 'MAPSDAP' OR "ref.queue.service" = 'MAPSDAP' THEN 1 ELSE 0 END AS dataset_map,
    CASE WHEN "ref.phone.service" = 'Network Support' OR "ref.queue.service" = 'Network Support' THEN 1 ELSE 0 END AS dataset_net,
    CASE WHEN "ref.phone.service" = 'Pension Wise' OR "ref.queue.service" = 'Pension Wise' THEN 1 ELSE 0 END AS dataset_pen,
    CASE WHEN "ref.phone.service" = 'Phones Team' OR "ref.queue.service" = 'Phones Team' THEN 1 ELSE 0 END AS dataset_pho,
    CASE WHEN "ref.phone.service" = 'Witness Service' OR "ref.queue.service" = 'Witness Service' THEN 1 ELSE 0 END AS dataset_wit,
    CASE WHEN "ref.phone.service" = 'unclaimed' OR "ref.queue.service" = 'unclaimed' THEN 1 ELSE 0 END AS dataset_fix,
    CASE WHEN "ref.phone.service" NOT IN ('Adviceline','Advicelink','Advisory Immigration','Birmingham Debt','Birmingham Macmillan',
                                      'Client Services','Consumer Service','Consumer Operations','Dudley Empowerment','EDF',
                                      'EU Citizens Rights','Healthwatch Isle of Wight','Help Through Hardship','Help To Claim',
                                      'Phones Team','IT Service Desk','MAPSDAP','Network Support','Pension Wise','Witness Service') THEN 1 ELSE 0 END as dataset_missing

FROM contact_trace_records CTR
LEFT JOIN reference_phonenumbers RPN ON CTR."systemendpoint.address" = RPN."ref.phone"
LEFT JOIN reference_queues RQU ON CTR."queue.name" = RQU."ref.queue"
