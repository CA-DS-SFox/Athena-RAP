CREATE TABLE ctas_week_to_date
WITH (
      format = 'Parquet',
      write_compression = 'SNAPPY')
AS
SELECT
    SUBSTR(initiationtimestamp,1, 10) as when_date,
    SUBSTR(initiationtimestamp, 12, 5) as when_time,
    SUBSTR(initiationtimestamp, 12, 2) as when_hour,
    date_format(CAST(SUBSTR(initiationtimestamp,1, 10) AS DATE), '%W') as when_day,
    date_format(CAST(SUBSTR(initiationtimestamp,1, 10) AS DATE), '%Y-%v') as when_week,
    CASE "initiationmethod" WHEN 'INBOUND' THEN 1 ELSE 0 END AS flag_inbound,
    CASE "initiationmethod" WHEN 'OUTBOUND' THEN 1 ELSE 0 END AS flag_outbound,
    CASE WHEN "initiationmethod" IN ('INBOUND','OUTBOUND') THEN 0 ELSE 1 END AS flag_other,
    "initiationtimestamp","initiationmethod","initialcontactid","systemendpoint.address","systemendpoint.type","agent.username","disconnectreason","contactid",
    "agent.routingprofile.name","queue.name","customerendpoint.address","queue.duration","attributes.timeinqueue","agent.agentinteractionduration",
    "agent.aftercontactworkduration","agent.customerholdduration","agent.longestholdduration","agent.numberofholds","agentconnectionattempts",
    "transferredtoendpoint.address","transferredtoendpoint.type","agent.hierarchygroups.level1.groupname","agent.hierarchygroups.level2.groupname",
    "agent.hierarchygroups.level3.groupname","agent.hierarchygroups.level4.groupname","agent.hierarchygroups.level5.groupname","attributes.numberofquestion",
    "attributes.question1","attributes.question1response","attributes.question2","attributes.question2response","attributes.question3",
    "attributes.question3response","attributes.question4","attributes.question4response","attributes.question5","attributes.question5response","queue.enqueuetimestamp",
    "queue.dequeuetimestamp","connectedtosystemtimestamp","agent.connectedtoagenttimestamp","disconnecttimestamp","lastupdatetimestamp","transfercompletedtimestamp",
    "agent.aftercontactworkstarttimestamp","agent.aftercontactworkendtimestamp","previouscontactid","nextcontactid","attributes.ooh_calls",
    "attributes.vmcalledservice","attributes.vmreceiveremail","attributes.vmsenderemail","attributes.finalservice","attributes.flowselection",
    "attributes.keypress","attributes.servicename","attributes.outcome","attributes.connectcontactid","attributes.endfragmentnum","attributes.startfragmentnum",
    "attributes.appname","attributes.language_check","attributes.transfername","attributes.istransfer","attributes.formember","attributes.memberid",
    "attributes.region","attributes.pensionwise","attributes.holidayname","attributes.publicholiday","attributes.ca_holiday","attributes.voicemailstatus",
    "attributes.country","attributes.vmcustomerqueueflow#1","references","channel","customerendpoint.type","attributes.vmcustomerqueueflow",
    CASE "systemendpoint.address"  WHEN '+443300544866' THEN 'Pensionwise' ELSE 'Other' END as dataset_pensionwise
from contact_trace_records 
WHERE "systemendpoint.address" = '+443300544866' AND 
       date_format(CAST(SUBSTR(initiationtimestamp,1, 10) AS DATE), '%Y-%v') = date_format(current_date, '%Y-%v')
